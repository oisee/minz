# MinZ SPEC v0.1 — SMC Anchors, ABI, Frames, Iterators (Anti‑C for Z80)

**Scope:** Нормативная спецификация ключевых элементов MinZ: *истинный SMC через «якоря» в теле функции*, выбор ABI, модели кадров (frames) для рекурсии/реентерабельности, правила понижения циклов под `DJNZ`, ссылки на итераторы, обработка ISR/NMI и банков, требования к инструментам отладочного вывода.

---

## 1. Термины и определения

- **Истинный SMC (Self‑Modifying Code):** изменение **байтов операндов** (и/или опкодов) **в коде** во время выполнения.
- **SMC‑якорь (anchor):** *первая точка употребления* параметра функции, сгенерированная как инструкция с **иммедиат‑операндом** *(например, `LD A, n`, `LD HL, nn`, `CP n`)*. Адрес этого операнда используется:
  1) для **патча** (подстановки аргумента) перед входом в функцию;
  2) как **«слот из кода»** для последующих чтений значения.
- **PATCH‑TABLE:** таблица патч‑точек (адрес, размер 1/2 байта, банк, тег параметра/якоря).
- **SMC undo‑log (SMC‑стек):** журнал байтов кода, сохраняемых перед патчем иммедиатов, чтобы восстановить их при выходе из фрейма (для рекурсии/реентерабельности).
- **SMC‑слоты:** фиксированные RAM‑адреса для параметров/локалов (альтернатива, без модификации кода).
- **ABI режимы:** `@abi(smc)` — через якоря; `@abi(slot)` — через фикс‑слоты; `@abi(reg)` — через регистры.
- **Frame режимы:** `@frame=none|spill|ringsize(N)|stack` — модель хранения локалов/состояния.
- **Iterator ref (`&i`):** тонкая ссылка на текущее значение счётчика; требует материализации `i` в адресуемом слоте.

---

## 2. Дефолтное поведение: SMC‑якоря в теле функции

**SPEC‑01 (MUST).** При `target=RAM` компилятор **MUST** использовать **истинный SMC по умолчанию**: для каждого параметра `p` в теле функции создаётся **ровно один канонический SMC‑якорь** `p$imm0` (см. SPEC‑02…05).

**SPEC‑02 (MUST).** «Первым употреблением» параметра считается **доминирующая точка** CFG, где значение требуется первым. Если такой точки нет (несколько ветвей), компилятор **MUST** вставить **синтетический общий якорь** перед разветвлением. (Разрешён альтернативный режим с несколькими якорями, но он **SHOULD** быть отключён по умолчанию.)

**SPEC‑03 (MUST).** Если окружение операции позволяет **иммедиат**, Якорь эмитится как инструкция с прямым **imm8/imm16**. Если нет — компилятор **MUST** вставить минимальную несущую загрузку с иммедиатом непосредственно **в месте первого употребления** (например, `LD A, n`).

**SPEC‑04 (MUST).** Перед `CALL f` все якоря `f` из `PATCH‑TABLE` **MUST** быть пропатчены значениями аргументов (для `imm16` — два байта в порядке LE). Если ISR/NMI может вмешаться — запись **SHOULD** быть защищена `DI/EI`.

**SPEC‑05 (SHOULD/MUST).** Все последующие использования параметра:
- **SHOULD** повторно использовать живой регистр, если это корректно по liveness;
- иначе **MUST** читать значение из **адреса якоря** `p$imm0` (`LD A,(p$imm0)` / `LD HL,(p$imm0)`).

**SPEC‑06 (MUST).** Компилятор **MUST** формировать `PATCH‑TABLE` для каждого `fun`: список `(symbol, addr, size, bank, param_tag)`.

---

## 3. Выбор ABI: когда не `@abi(smc)`

**SPEC‑07 (Default).** При `target=RAM` и отсутствии ограничений из SPEC‑08…12 ABI **MUST** быть `@abi(smc)`.

**SPEC‑08 (MUST).** Если код исполняется из ROM/immutable, `@abi(smc)` **MUST NOT** применяться → использовать `@abi(slot)` или `@abi(reg)`.

**SPEC‑09 (SHOULD/MUST).** При **конкурентном доступе** к одним и тем же якорям (ISR/NMI/кооператив) компилятор **SHOULD** сгенерировать **пер‑контекстные копии кода/якорей**. Если это невозможно/запрещено по размеру — **MUST** применяться `@abi(slot)` для конфликтующего пути.

**SPEC‑10 (SHOULD).** Если аргумент меняется на **каждом вызове**, а выгода `imm` по T‑states не перекрывает цену патча, компилятор **SHOULD** выбрать `@abi(slot|reg)` для данного параметра/вызова.

**SPEC‑11 (SHOULD/MUST).** Если банк, где расположен якорь, недоступен для безопасного патча → **SHOULD** обрамлять патч `using bank[n]`; если невозможно — **MUST** `@abi(slot)`.

**SPEC‑12 (SHOULD).** При `-finstrument`/сложном трассинге/дебаге компилятор **SHOULD** предлагать `@abi(slot)`.

---

## 4. Рекурсия и реентерабельность

**SPEC‑13 (SHOULD).** Рекурсивные функции под `@abi(smc)` **SHOULD** использовать **SMC undo‑log**: перед репатчем якорей сохранять старые байты в стек, на выходе восстанавливать. Для `imm16` — `DI/EI`.

**SPEC‑14 (MUST).** Если в функции возможна рекурсия/реентерабельность и не указано `@frame`, компилятор **MUST** выдать предупреждение и применить `@frame=spill` по умолчанию, либо требовать явного выбора.

**SPEC‑15 (Frame modes).**
- `@frame=spill` (MUST be supported): копирование диапазона фикс‑слотов локалов в frame‑стек при входе в «глубокий» вызов; восстановление при выходе.
- `@frame=ringsize(N)` (SHOULD be supported): N независимых копий локалов; ссылки на локалы извне лексической области **MUST NOT** допускаться; внутри — разрешены как fat‑ptr (frame_id+offset).
- `@frame=stack` (MAY): IX/HL‑кадр как совместимый fallback.

---

## 5. Итераторы, `DJNZ` и ссылки

**SPEC‑16 (SHOULD).** `for i in N..0 { ... }` при константном `N` **SHOULD** понижаться в `DJNZ` (включая вычисление `i=B-1`).

**SPEC‑17 (MUST).** При наличии ссылки `&i` (или эквивалента) компилятор **MUST** материализовать `i` в адресуемом слоте (либо деоптимизировать `DJNZ`, либо добавлять write‑back счётчика в слот). `&i` **MUST NOT** «убегать» за пределы лексической области.

---

## 6. `match` и таблицы переходов

**SPEC‑18 (SHOULD).** Плотные диапазоны кейсов **SHOULD** понижаться в таблицу переходов (`JP (HL)`), разрежённые — в цепочку сравнений `CP`/`JR Z`.

---

## 7. Банки и ISR/NMI

**SPEC‑19 (MUST).** При патче якорей в другом банке **MUST** выполняться временное подключение банка (`using bank[n]`) на время чтения/записи.

**SPEC‑20 (SHOULD/MUST).** При наличии ISR/NMI, изменяющих те же якоря, патч **SHOULD** защищаться `DI/EI` (особенно `imm16`), либо **MUST** использоваться `@abi(slot)`/пер‑контекстный код.

---

## 8. Инструменты и артефакты

**SPEC‑21 (MUST).** Генерировать аннотированный листинг (`.a80`) с пометками якорей:  
`; x$imm0 — %IMM8_PATCH`, `; reuse: LD A,(x$imm0)` и т.п.

**SPEC‑22 (MUST).** Генерировать:
- `PATCH‑TABLE.json` — адреса/размеры/банки всех якорей;
- `MEMORY‑MAP.json` — слоты/банки/размеры;
- (при `@frame=spill`) `FRAME‑MAP.json` — диапазоны локалов, оценка T‑states.

**SPEC‑23 (SHOULD).** Флаги:  
`-report-smc-anchors`, `-fsmc-snapshot=undo|all`, `-fsmc-di-ei=auto|off`, `-abi=auto|smc|slot|reg`, `-fringsize=N`, `-finstrument`.

---

## 9. Соответствие и тестирование

**SPEC‑24 (MUST).** Набор тестов должен покрывать:  
- единичный якорь на параметр и его повторные использования;  
- ветвление без единой доминации (синтетический якорь);  
- рекурсию с SMC undo‑log;  
- `for N..0` и `&i`;  
- ISR‑конкуренцию (пер‑контекстные копии/slot‑fallback);  
- банки и `imm16` патч под `DI/EI`.

---

## 10. Приложение — таблица принятия решений (ABI)

| Ситуация | ABI |
|---|---|
| `target=RAM`, без ограничений | `@abi(smc)` |
| Инварианты внутри цикла | `@abi(smc)` (патч один раз) |
| Параметры меняются каждый вызов и мало повторных использований | `@abi(slot|reg)` |
| ISR/NMI меняют те же якоря | Пер‑контекстный код **или** `@abi(slot)` |
| ROM/immutable | `@abi(slot|reg)` |
| Банк недоступен для безопасного патча | `@abi(slot)` |

