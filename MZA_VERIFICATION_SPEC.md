# MZA Assembler Verification Project - Tech Spec

## üéØ Mission
Ensure 100% compatibility between MinZ's built-in assembler (MZA) and industry-standard Z80 assemblers by automated differential testing.

## üìã Scope & Objectives

### Primary Goal
Verify that all `.a80` assembly files generated by MinZ compile identically with:
- **MZA** (MinZ's built-in assembler)  
- **SjASMPlus** (reference standard Z80 assembler)

### Success Criteria
- ‚úÖ 100% of generated `.a80` files assemble without errors
- ‚úÖ Binary output byte-for-byte identical between MZA and SjASMPlus
- ‚úÖ Automated test suite catches regressions immediately
- ‚úÖ Clear documentation of any intentional differences

## üõ†Ô∏è Technical Approach

### Phase 1: Assessment & Baseline
1. **Inventory all `.a80` files** in MinZ codebase
2. **Create test harness** for differential compilation
3. **Establish baseline** - current compatibility rate
4. **Document incompatibilities** with detailed analysis

### Phase 2: Core Compatibility
1. **Fix critical opcodes** causing assembly failures
2. **Align directive syntax** (ORG, DB, DW, etc.)
3. **Fix label/symbol resolution** differences
4. **Ensure expression evaluation** matches SjASMPlus

### Phase 3: Advanced Features
1. **Macro compatibility** (if used)
2. **Conditional assembly** directives
3. **Include/import** statement handling
4. **Complex expression** evaluation

### Phase 4: Automation & CI
1. **Automated regression tests** on every MZA change
2. **Performance benchmarks** (MZA vs SjASMPlus speed)
3. **Integration with main build** pipeline

## üìÅ Deliverables

### Testing Infrastructure
- `scripts/test_mza_compatibility.sh` - Main test runner
- `tests/asm/` - Assembly test cases directory
- `tests/asm/differential/` - Comparison results
- `tools/asm_differ.py` - Binary diff analyzer

### Documentation
- `MZA_COMPATIBILITY_REPORT.md` - Current status
- `MZA_DIFFERENCES.md` - Documented intentional differences
- `ASM_TEST_GUIDE.md` - How to add new tests

### Code Improvements
- MZA bug fixes in `minzc/pkg/z80asm/`
- Test cases covering edge cases
- Performance optimizations

## üîß Technical Implementation

### Test Harness Structure
```bash
#!/bin/bash
# For each .a80 file:
for asm_file in examples/**/*.a80 tests/**/*.a80; do
    # Compile with MZA
    ./minzc/mza "$asm_file" -o "test_mza.bin"
    
    # Compile with SjASMPlus  
    sjasmplus "$asm_file" --output="test_sjasmplus.bin"
    
    # Compare binaries
    if ! diff -q "test_mza.bin" "test_sjasmplus.bin"; then
        echo "DIFF: $asm_file"
        # Log detailed differences
    fi
done
```

### Key Areas to Investigate
1. **Opcode encoding** - ensure identical machine code
2. **Label resolution** - forward/backward references
3. **Expression evaluation** - arithmetic, logical operations
4. **Directive handling** - ORG, DB, DW, DEFB, DEFW
5. **Symbol table** - case sensitivity, scope rules
6. **Error reporting** - helpful vs. cryptic messages

## ü§ù Collaboration Rules

### ‚ö†Ô∏è CRITICAL: Non-Interference Policy
1. **READ-ONLY** access to main development files
2. **NO MODIFICATIONS** to core compiler without explicit approval
3. **SEPARATE BRANCH** for all MZA improvements (`mza-verification`)
4. **COORDINATION** required before merging any changes

### Communication Protocol
1. **Daily status updates** in `MZA_PROGRESS.md`
2. **Bug reports** filed as GitHub issues with `[MZA]` prefix
3. **Proposed fixes** submitted as pull requests for review
4. **Emergency coordination** if critical MZA bugs block main development

### File Boundaries
#### ‚úÖ Safe to Modify
- `minzc/pkg/z80asm/` (assembler implementation)
- `tests/asm/` (new test files)
- `scripts/mza_*` (MZA-specific scripts)
- `docs/MZA_*` (MZA documentation)

#### ‚ùå Requires Approval
- `minzc/cmd/` (CLI interfaces)
- `minzc/pkg/codegen/` (code generation)
- `examples/*.minz` (existing examples)
- Core build scripts

#### üö´ Absolutely Off-Limits
- `minzc/pkg/semantic/` (semantic analyzer)
- `minzc/pkg/parser/` (parsers)
- `grammar.js` (language grammar)
- Game development files (`games/`)

## üìä Success Metrics

### Quantitative Targets
- **Assembly Success Rate**: 95%+ ‚Üí 100%
- **Binary Compatibility**: 90%+ ‚Üí 100%
- **Performance**: MZA ‚â§ 2x SjASMPlus assembly time
- **Test Coverage**: 100% of MinZ-generated assembly patterns

### Qualitative Goals
- Clear error messages on assembly failures
- Comprehensive documentation of differences
- Automated CI integration
- Zero regressions in main development

## üöÄ Getting Started

### Setup Instructions
1. Clone MinZ repository to separate working directory
2. Install SjASMPlus: `brew install sjasmplus` (macOS)
3. Build current MZA: `cd minzc && make build`
4. **Setup MCP AI Colleague**: Use `minzc/mcp-ai-colleague` for advanced analysis
   - Multi-model perspectives (GPT-4, GPT-5, o4-mini)
   - Assembly analysis tools available
   - Parser issue diagnosis capabilities
5. Run baseline test: `./scripts/test_mza_compatibility.sh`
6. Document current status in `MZA_BASELINE_REPORT.md`

### ü§ñ MCP AI Analysis Available
```bash
# Use MCP tools for advanced analysis
export AZURE_OPENAI_ENDPOINT="your-endpoint"
export AZURE_OPENAI_API_KEY="your-key"

# Available MCP analysis tools:
# - mcp__minz-ai__ask_ai - General MinZ questions
# - mcp__minz-ai__analyze_parser - Assembly/parser issues  
# - mcp__minz-ai__compare_approaches - Different implementation strategies
# - mcp__minz-ai__ask_gpt4 - Large file analysis (1M tokens)
# - mcp__minz-ai__ask_o4_mini - Deep debugging analysis
```

### First Tasks
1. **Inventory Phase**: Count all `.a80` files and categorize
2. **Quick Assessment**: Test 10 representative files
3. **Tool Setup**: Create basic diff testing infrastructure
4. **Report**: Document current compatibility percentage

---

**Contact**: Coordinate with main development team before making any changes to core MinZ files. Focus on isolated MZA improvements and comprehensive testing infrastructure.

This project runs **parallel** to main development - success is measured by improvement without interference! üéØ