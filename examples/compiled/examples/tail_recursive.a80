; MinZ generated code
; Generated: 2025-07-07 21:42:15


; Code section
    ORG $8000


; Function: factorial_tail
; IsSMCDefault=true, IsSMCEnabled=true
factorial_tail:
factorial_tail_param_n EQU factorial_tail + 1
    LD A, #00      ; Parameter n
factorial_tail_param_acc EQU factorial_tail + 3
    LD HL, #0000   ; Parameter acc
    ; Recursive function - will need context save/restore
    LD A, (factorial_tail_param_n)
    LD (IX-6), A
    ; r4 = 0
    LD A, 0
    LD (IX-8), A
    ; r5 = r3 == r4
    LD L, (IX-6)
    LD H, (IX-5)
    PUSH HL
    LD L, (IX-8)
    LD H, (IX-7)
    POP DE
    OR A      ; Clear carry
    SBC HL, DE
    JP Z, .L1
    LD HL, 0
    JP .L2
.L1:
    LD HL, 1
.L2:
    LD (IX-10), L
    LD (IX-9), H
    ; jump_if_not r5, else_1
    LD A, (IX-10)
    OR A
    JP Z, else_1
    LD HL, (factorial_tail_param_acc)
    LD (IX-12), L
    LD (IX-11), H
    ; return r6
    LD L, (IX-12)
    LD H, (IX-11)
    LD SP, IX
    POP IX
    RET
    ; jump end_if_2
    JP end_if_2
    ; else_1:
else_1:
    ; end_if_2:
end_if_2:
    LD A, (factorial_tail_param_n)
    LD (IX-14), A
    ; r8 = 1
    LD A, 1
    LD (IX-16), A
    ; r9 = r7 - r8
    LD L, (IX-14)
    LD H, (IX-13)
    PUSH HL
    LD L, (IX-16)
    LD H, (IX-15)
    POP DE
    EX DE, HL
    OR A      ; Clear carry
    SBC HL, DE
    LD (IX-18), L
    LD (IX-17), H
    LD A, (factorial_tail_param_n)
    LD (IX-20), A
    LD HL, (factorial_tail_param_acc)
    LD (IX-22), L
    LD (IX-21), H
    ; r12 = r10 * r11
    ; TODO: Multiplication
    LD HL, 0
    LD (IX-24), L
    LD (IX-23), H
    ; === SMC Recursive Context Save ===
    LD A, (factorial_tail_param_n)
    PUSH AF
    LD HL, (factorial_tail_param_acc)
    PUSH HL
    ; === Update SMC Parameters ===
    CALL factorial_tail
    ; === SMC Recursive Context Restore ===
    POP HL
    LD (factorial_tail_param_acc), HL
    POP AF
    LD (factorial_tail_param_n), A
    LD (IX-26), L
    LD (IX-25), H
    ; return r13
    LD L, (IX-26)
    LD H, (IX-25)
    LD SP, IX
    POP IX
    RET

; Function: factorial
; IsSMCDefault=true, IsSMCEnabled=true
factorial:
factorial_param_n EQU factorial + 1
    LD A, #00      ; Parameter n
    LD A, (factorial_param_n)
    LD (IX-4), A
    ; r3 = 1
    LD A, 1
    LD (IX-6), A
    ; r4 = call factorial_tail
    CALL factorial_tail
    LD (IX-8), L
    LD (IX-7), H
    ; return r4
    LD L, (IX-8)
    LD H, (IX-7)
    LD SP, IX
    POP IX
    RET

; Function: sum_tail
; IsSMCDefault=true, IsSMCEnabled=true
sum_tail:
sum_tail_param_n EQU sum_tail + 1
    LD HL, #0000   ; Parameter n
sum_tail_param_acc EQU sum_tail + 4
    LD HL, #0000   ; Parameter acc
    ; Recursive function - will need context save/restore
    LD HL, (sum_tail_param_n)
    LD (IX-6), L
    LD (IX-5), H
    ; r4 = 0
    LD A, 0
    LD (IX-8), A
    ; r5 = r3 == r4
    LD L, (IX-6)
    LD H, (IX-5)
    PUSH HL
    LD L, (IX-8)
    LD H, (IX-7)
    POP DE
    OR A      ; Clear carry
    SBC HL, DE
    JP Z, .L3
    LD HL, 0
    JP .L4
.L3:
    LD HL, 1
.L4:
    LD (IX-10), L
    LD (IX-9), H
    ; jump_if_not r5, else_3
    LD A, (IX-10)
    OR A
    JP Z, else_3
    LD HL, (sum_tail_param_acc)
    LD (IX-12), L
    LD (IX-11), H
    ; return r6
    LD L, (IX-12)
    LD H, (IX-11)
    LD SP, IX
    POP IX
    RET
    ; jump end_if_4
    JP end_if_4
    ; else_3:
else_3:
    ; end_if_4:
end_if_4:
    LD HL, (sum_tail_param_n)
    LD (IX-14), L
    LD (IX-13), H
    ; r8 = 1
    LD A, 1
    LD (IX-16), A
    ; r9 = r7 - r8
    LD L, (IX-14)
    LD H, (IX-13)
    PUSH HL
    LD L, (IX-16)
    LD H, (IX-15)
    POP DE
    EX DE, HL
    OR A      ; Clear carry
    SBC HL, DE
    LD (IX-18), L
    LD (IX-17), H
    LD HL, (sum_tail_param_acc)
    LD (IX-20), L
    LD (IX-19), H
    LD HL, (sum_tail_param_n)
    LD (IX-22), L
    LD (IX-21), H
    ; r12 = r10 + r11
    LD L, (IX-20)
    LD H, (IX-19)
    PUSH HL
    LD L, (IX-22)
    LD H, (IX-21)
    POP DE
    ADD HL, DE
    LD (IX-24), L
    LD (IX-23), H
    ; === SMC Recursive Context Save ===
    LD HL, (sum_tail_param_n)
    PUSH HL
    LD HL, (sum_tail_param_acc)
    PUSH HL
    ; === Update SMC Parameters ===
    CALL sum_tail
    ; === SMC Recursive Context Restore ===
    POP HL
    LD (sum_tail_param_acc), HL
    POP HL
    LD (sum_tail_param_n), HL
    LD (IX-26), L
    LD (IX-25), H
    ; return r13
    LD L, (IX-26)
    LD H, (IX-25)
    LD SP, IX
    POP IX
    RET

; Function: main
; IsSMCDefault=true, IsSMCEnabled=true
main:
    ; r2 = 5
    LD A, 5
    LD (IX-4), A
    ; r3 = call factorial
    CALL factorial
    LD (IX-6), L
    LD (IX-5), H
    ; store , r3
    LD L, (IX-6)
    LD H, (IX-5)
    LD (IX-2), L
    LD (IX-1), H
    ; r5 = 100
    LD A, 100
    LD (IX-10), A
    ; r6 = 0
    LD A, 0
    LD (IX-12), A
    ; r7 = call sum_tail
    CALL sum_tail
    LD (IX-14), L
    LD (IX-13), H
    ; store , r7
    LD L, (IX-14)
    LD H, (IX-13)
    LD (IX-8), L
    LD (IX-7), H
    ; return
    LD SP, IX
    POP IX
    RET

    END main
